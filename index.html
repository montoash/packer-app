<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">

    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Packer">
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/3498db/ffffff?text=P">
    <link rel="icon" href="https://placehold.co/32x32/3498db/ffffff?text=P">

    <title>Packer</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />

    <style>
        :root { --sat: env(safe-area-inset-top); --sar: env(safe-area-inset-right); --sab: env(safe-area-inset-bottom); --sal: env(safe-area-inset-left); }
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        #app-container { padding-bottom: calc(5rem + var(--sab)); }
        #add-item-form-container { padding-bottom: calc(1rem + var(--sab)); }
        .task-item:active { transform: scale(0.98); background-color: #f9fafb; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Splash/Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-gray-50 flex flex-col items-center justify-center z-50 transition-opacity duration-500">
        <div class="w-20 h-20 bg-blue-500 rounded-2xl flex items-center justify-center shadow-lg">
            <span class="text-white text-4xl font-bold">P</span>
        </div>
        <p id="loading-message" class="mt-4 text-gray-600 font-medium">Connecting to database...</p>
    </div>

    <!-- Main App Container -->
    <main id="app-container" class="max-w-lg mx-auto h-screen flex flex-col opacity-0 transition-opacity duration-500">
        <header class="p-4 flex justify-between items-center bg-gray-50/80 backdrop-blur-sm sticky top-0 z-10 border-b border-gray-200" style="padding-top: calc(1rem + var(--sat));">
            <h1 class="text-2xl font-bold text-gray-900">Packing List</h1>
            <button id="reset-list-btn" class="flex items-center gap-1 text-sm bg-red-500 text-white px-3 py-2 rounded-lg shadow active:bg-red-600 transition">
                <span class="material-symbols-outlined" style="font-size: 18px;">restart_alt</span>
                New Trip
            </button>
        </header>

        <div id="item-list" class="flex-grow overflow-y-auto px-4 pt-4 space-y-4">
            <!-- Items grouped by location will be injected here -->
        </div>
    </main>

    <!-- Add Item Form -->
    <div id="add-item-form-container" class="fixed bottom-0 left-0 right-0 max-w-lg mx-auto bg-gray-50 p-4 border-t border-gray-200">
        <form id="add-item-form" class="flex items-center space-x-2">
            <input type="text" id="item-input" placeholder="Add item (e.g., Toothbrush)" class="w-full px-4 py-3 bg-white border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none transition" autocomplete="off">
            <button type="submit" class="bg-blue-500 text-white p-3 rounded-full shadow-md hover:bg-blue-600 active:bg-blue-700 transform active:scale-95 transition">
                <span class="material-symbols-outlined">add</span>
            </button>
        </form>
    </div>

    <!-- Location Modal -->
    <div id="location-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-40 hidden">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm">
            <h2 class="text-lg font-bold text-gray-900">Set Location</h2>
            <p class="text-sm text-gray-600 mt-1">Where do you get "<span id="modal-item-name" class="font-semibold"></span>"?</p>
            <form id="location-form">
                <input type="text" id="location-input" placeholder="e.g., Upstairs Bathroom" class="w-full mt-4 px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                <div class="flex justify-end space-x-2 mt-4">
                    <button type="button" id="cancel-location-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-500 rounded-lg hover:bg-blue-600">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, onSnapshot, query, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- PASTE YOUR FIREBASE CONFIG HERE ---
        const firebaseConfig = {
          apiKey: "AIzaSyAFM9ZFOZWP_VP_73ci0B74VoumndJfBRw",
          authDomain: "packing-helper-beb5e.firebaseapp.com",
          projectId: "packing-helper-beb5e",
          storageBucket: "packing-helper-beb5e.firebasestorage.app",
          messagingSenderId: "853350644569",
          appId: "1:853350644569:web:1b29746439551382766a48"
        };
        // -----------------------------------------

        // --- INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let userId;
        let itemLocations = new Map(); // Master list: 'toothbrush' -> 'Bathroom'
        let packingList = []; // Current trip list: [{ text: 'Toothbrush', location: 'Bathroom', packed: false }]
        let unsubItemLocations, unsubPackingList;

        const loadingScreen = document.getElementById('loading-screen');
        const loadingMessage = document.getElementById('loading-message');
        const appContainer = document.getElementById('app-container');
        const itemListEl = document.getElementById('item-list');
        const addItemForm = document.getElementById('add-item-form');
        const itemInput = document.getElementById('item-input');
        const resetListBtn = document.getElementById('reset-list-btn');
        
        const locationModal = document.getElementById('location-modal');
        const locationForm = document.getElementById('location-form');
        const locationInput = document.getElementById('location-input');
        const cancelLocationBtn = document.getElementById('cancel-location-btn');
        const modalItemName = document.getElementById('modal-item-name');
        let pendingItem = null;

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, user => {
            if (user) {
                userId = user.uid;
                loadingMessage.textContent = 'Loading your data...';
                setupListeners();
            } else {
                signInAnonymously(auth).catch(error => {
                    console.error("Anonymous sign-in failed:", error);
                    loadingMessage.textContent = 'Authentication failed. Please refresh.';
                });
            }
        });

        // --- FIRESTORE LISTENERS ---
        function setupListeners() {
            // Listener for the master item locations
            const itemLocationsRef = collection(db, `users/${userId}/itemLocations`);
            unsubItemLocations = onSnapshot(itemLocationsRef, (snapshot) => {
                snapshot.docs.forEach(doc => {
                    itemLocations.set(doc.id, doc.data().location);
                });
                // Once locations are loaded, load the packing list
                if (!unsubPackingList) setupPackingListListener();
            });
        }

        function setupPackingListListener() {
             // Listener for the current packing list
            const packingListRef = collection(db, `users/${userId}/packingList`);
            unsubPackingList = onSnapshot(query(packingListRef), (snapshot) => {
                packingList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPackingList();
                showApp();
            });
        }
        
        // --- RENDERING ---
        function renderPackingList() {
            itemListEl.innerHTML = '';
            if (packingList.length === 0) {
                itemListEl.innerHTML = `<div class="text-center py-16">
                    <span class="material-symbols-outlined text-5xl text-gray-300">luggage</span>
                    <p class="mt-2 text-gray-500">Your packing list is empty.</p>
                </div>`;
                return;
            }

            const groupedByLocation = packingList.reduce((acc, item) => {
                const location = item.location || 'Uncategorized';
                if (!acc[location]) acc[location] = [];
                acc[location].push(item);
                return acc;
            }, {});

            const sortedLocations = Object.keys(groupedByLocation).sort();

            sortedLocations.forEach(location => {
                const locationContainer = document.createElement('div');
                locationContainer.innerHTML = `
                    <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-2 px-1">${location}</h2>
                    <div class="bg-white rounded-xl shadow-sm">
                        ${groupedByLocation[location].map(createItemElement).join('')}
                    </div>
                `;
                itemListEl.appendChild(locationContainer);
            });
        }

        function createItemElement(item) {
            return `<div class="task-item flex items-center p-3 border-b border-gray-200 last:border-b-0" data-id="${item.id}">
                <input type="checkbox" ${item.packed ? 'checked' : ''} class="item-checkbox h-5 w-5 rounded-full border-gray-300 text-blue-500 focus:ring-blue-500 transition">
                <p class="flex-grow ml-3 ${item.packed ? 'line-through text-gray-400' : 'text-gray-800'}">${item.text}</p>
            </div>`;
        }

        function showApp() {
            if (appContainer.classList.contains('opacity-0')) {
                loadingScreen.classList.add('opacity-0');
                appContainer.classList.remove('opacity-0');
                setTimeout(() => loadingScreen.style.display = 'none', 500);
            }
        }

        // --- CORE LOGIC ---
        async function handleAddItem(e) {
            e.preventDefault();
            const text = itemInput.value.trim();
            if (!text) return;
            itemInput.value = '';
            
            const normalizedText = text.toLowerCase();
            
            if (itemLocations.has(normalizedText)) {
                const location = itemLocations.get(normalizedText);
                await createPackingListItem(text, location);
            } else {
                pendingItem = text;
                modalItemName.textContent = text;
                locationModal.classList.remove('hidden');
                locationInput.focus();
            }
        }

        async function handleLocationSubmit(e) {
            e.preventDefault();
            const location = locationInput.value.trim();
            if (!location || !pendingItem) return;

            const normalizedText = pendingItem.toLowerCase();
            
            // Save to master list
            const itemLocationRef = doc(db, `users/${userId}/itemLocations`, normalizedText);
            await setDoc(itemLocationRef, { location });
            itemLocations.set(normalizedText, location); // Update local map

            // Add to packing list
            await createPackingListItem(pendingItem, location);
            
            closeLocationModal();
        }
        
        async function createPackingListItem(text, location) {
            const newItemRef = doc(collection(db, `users/${userId}/packingList`));
            await setDoc(newItemRef, {
                text,
                location,
                packed: false,
                createdAt: new Date()
            });
        }
        
        function closeLocationModal() {
            locationModal.classList.add('hidden');
            locationInput.value = '';
            pendingItem = null;
        }

        async function handleItemListClick(e) {
            const itemEl = e.target.closest('.task-item');
            if (!itemEl) return;
            
            const itemId = itemEl.dataset.id;
            const item = packingList.find(i => i.id === itemId);
            
            const itemRef = doc(db, `users/${userId}/packingList`, itemId);
            await setDoc(itemRef, { packed: !item.packed }, { merge: true });
        }

        async function handleResetList() {
            if (!confirm("Start a new trip? This will un-pack all items on your list.")) return;
            
            const batch = writeBatch(db);
            packingList.forEach(item => {
                if (item.packed) {
                    const itemRef = doc(db, `users/${userId}/packingList`, item.id);
                    batch.update(itemRef, { packed: false });
                }
            });
            await batch.commit();
        }

        // --- EVENT LISTENERS ---
        addItemForm.addEventListener('submit', handleAddItem);
        locationForm.addEventListener('submit', handleLocationSubmit);
        cancelLocationBtn.addEventListener('click', closeLocationModal);
        itemListEl.addEventListener('click', handleItemListClick);
        resetListBtn.addEventListener('click', handleResetList);

    </script>
</body>
</html>
